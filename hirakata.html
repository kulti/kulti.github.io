<!DOCTYPE html>
<html>
<body>

<p id="results" >Осталось: 46</p>

<form id="frm">
  <div id="quest" style="display:inline">? : </div><input id="answer" style="display:inline" type="text" name="fname" onkeypress="return on_key_press(event)" ><br>
  <input id="btn" type="button" onclick="on_begin(hira)" value="Хирагана">
  <input id="btn" type="button" onclick="on_begin(kata)" value="Катакана">
</form>

<script>
var index;
var errors;
var times;
var dict;
var hira = "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわんを";
var kata = "アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワンヲ";
var roma = new Array("a", "i", "u", "e", "o", "ka", "ki", "ku", "ke", "ko", "sa", "shi", "su", "se", "so", "ta", "chi", "tsu", "te", "to", "na", "ni", "nu", "ne", "no", "ha", "hi", "fu", "he", "ho", "ma", "mi", "mu", "me", "mo", "ya", "yu", "yo", "ra", "ri", "ru", "re", "ro", "wa", "n", "wo");
var i = 0;
var begin_time;

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex ;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

function on_begin(d) {
  dict = d;
  index = new Array;
  times = new Array;
  for (i = 0; i < roma.length; ++i) {
    index[i] = i;
    times[i] = 0;
  }
  errors = new Array(index.length);
  shuffle(index);
  i = 0;

  document.getElementById("quest").style.display = "inline";
  document.getElementById("answer").style.display = "inline";
  document.getElementById("btn").style.display = "none";
  show_next_quest();
}

function on_key_press(e) {
  if(e.keyCode == 13) {
    times[index[i]] = new Date().getTime() - begin_time;
    if (roma[index[i]] != document.getElementById("answer").value) {
      errors[i] = document.getElementById("answer").value;
    }
    i = i + 1;
    if (i == index.length) {
      document.getElementById("frm").style.display = "none";
      show_results();
    } else {
      show_next_quest();
    }
    return false;
  }
  return true;
}

function show_next_quest() {
  document.getElementById("results").innerHTML = "Осталось: " + (index.length - i);
  document.getElementById("quest").innerHTML = dict.charAt(index[i]) + " : ";
  document.getElementById("answer").value = "";
  document.getElementById("answer").focus();
  begin_time = new Date().getTime();
}

function show_results() {
  var errors_num = 0;
  var errors_str = "";
  var total_time = 0;
  for (i = 0; i < errors.length; ++i) {
    if (errors[i] == "" || errors[i]) {
      errors_num++;
      errors_str = errors_str + "<br>" + dict.charAt(index[i]) + " : " + roma[index[i]] + " (Ваш ответ '" + errors[i] + "')"
    } else {
      total_time = total_time + times[index[i]];
    }
  }

  sort_index_by_time();
  var times_str = "";
  for (i = 0; i < times.length; ++i) {
    if (times[index[i]]) {
      times_str = times_str + "<br>" + dict.charAt(index[i]) + " : " + times[index[i]]/1000;
    }
  }
  document.getElementById("results").innerHTML = "Oшибок: " + errors_num + errors_str + "<br>Время на правильные ответы: " + total_time/1000 + times_str;
}

function sort_index_by_time() {
  for (j = 0; j < index.length; ++j) {
    for (i = 0; i < index.length - j - 1; ++i) {
      if (times[index[i]] < times[index[i + 1]]) {
        t = index[i];
        index[i] = index[i + 1];
        index[i + 1] = t;
      }
    }
  }
}
</script>

</body>
</html>
